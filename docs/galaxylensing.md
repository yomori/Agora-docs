# Galaxy lensing 

Galaxy weak lensing can be found in

```globus: components/galaxylensing/```

In this directory there are three subdirectories

```/desy1```
```/desy3```
```/lssty1```

which correspond to DES-Y1, DES-Y3 and LSST-Y1 shear products. Inside each of these folders,
there are further directories:

```/catalogs```
```/maps```
```/nz```

which correspond to the redshift distributons n(z), noiseless maps and catalogs.

---------------------------------------
# n(z)

The n(z) used to create galaxy catalogues/maps are stored in these directories. These have file names like:

```nz_{expt}_{year}_{galaxytype}_{nbins}bins.txt```

where:<BR>


```expt``` is the experiment (for now ```des``` or ```lsst```)<BR>
```year``` is the specific data analysis year (```y1``` or ```y3``` for DES, ```y1``` for LSST)<BR>
```galaxytype``` is ```lens``` (lens galaxies) or ```srcs``` (source galaxies)<BR>
```nbins``` is the number of tomographic bins. <BR>

The columns are organized as z, bin1, bin2 ... etc.<BR>
(Note: the z spacing depends on where the n(z) came from, and is therefore file dependent).


For DES, the n(z) can also be extracted from their publicly available datavector fits files:<BR>
DES-Y1: [2pt_NG_mcal_1110.fits](http://desdr-server.ncsa.illinois.edu/despublic/y1a1_files/chains/2pt_NG_mcal_1110.fits) <BR>
DES-Y3: [2pt_NG_final_2ptunblind_02_26_21_wnz_maglim_covupdate.fits](http://desdr-server.ncsa.illinois.edu/despublic/y3a2_files/datavectors/2pt_NG_final_2ptunblind_02_26_21_wnz_maglim_covupdate.fits)

For LSST, the n(z) were taken from the [DESC Science Requirement Document (SRD)](https://arxiv.org/abs/1809.01669)

---------------------------------------
# Maps

These are signal-only convergence and shear maps. These maps are generated by stacking raytraced lenisng maps weighting the shells:
$$
\kappa(\hat{n}) = \sum_{z=0}^{z=8.6} k(\hat{n},z) n(z) dz
$$
where $n(z)$ is the redshift distribution in the ```nz``` directory. These have file names like:

```raytrace_kg1g2_${expt}_${year}_${galaxytype}_zbin${zbin}_fullsky.fits```

and the maps can be read using:
```python
k, g1, g2 = hp.read_map(file_galaxylensing,field=[0,1,2])
```



There are also maps of the intrinsic alignment constructed by stacking the dark matter density shells and multiplying by weights 
$$\kappa^{j}_{\rm IA}(\hat{n})=\sum_{i} d\chi\ W^{j}_{\rm IA}(\chi_{i})\delta^{i}_{\rm DM}(\chi_{i},\hat{n})$$
where the intrinstic alignment kernel is $W^{j}_{\rm IA}(\chi)= -A_{\rm IA}C_{1}\rho_{\rm crit,0}\frac{\Omega_{\rm m,0 }}{D(z)}\left(\frac{1+z}{1+z_{0}}\right)^{\eta}\frac{dn^{j}_{\rm s}}{dz}\frac{dz}{d\chi}$.<BR>

$$\gamma^{j}_{{\rm IA},\ell m}=-\sqrt{\frac{(\ell+2)(\ell-1)}{\ell(\ell+1)}}\kappa^{j}_{{\rm IA},\ell m},%+i\kappa^{B}_{\ell m})$$ 
This is converted into shear maps using spin-weighted spherical harmonics:

$$\gamma^{j}_{{\rm IA},1}+i\gamma^{j}_{{\rm IA},2}=\sum_{\ell m}\gamma^{j}_{{\rm IA}, \ell m}\ _{2}Y_{\ell m},$$

These have file names like:

```raytrace_IAkg1g2_${expt}_${year}_${galaxytype}_zbin${zbin}_fullsky_IA_{IAparams}.fits```

where ```IAparams``` denotes ```A_IA```,```n_IA```, and ```z0``` parameters used (in that order).

 These maps can be read using:
```python
k, g1, g2 = hp.read_map(file_galaxylensingIA,field=[0,1,2])
```

---------------------------------------
# Catalogs

These are signal+noise catalogs. Since the fiducial approach makes use of real data catalogs, these only exist for DES-Y1 and DES-Y3 (but one should be able generate one for LSST easily).
These catalogs are generated by first taking the data shape catalog and randomly rotating the ellipticities 

$e^{\rm rot}_{1}=\hspace{0.8em}e_{1}'\cos(2\varphi)+e'_{2}\sin(2\varphi)$<BR>
$e^{\rm rot}_{2}=-e_{1}'\sin(2\varphi)\hspace{0.1em}+e'_{2}\cos(2\varphi)$

and then adding the noiseless shear signal at the locations of real galaxies.

These files have names like:

```cat_raytrace_${expt}_e1e2_zbin${zbin}_patch1_randrot.fits```


 These catalogs are in fits format that can be opened using:
```python
from astropy.io import fits
d = fits.open(file_catgalaxylensing)
```

and the columns included are:
```
 RA           : Right ascension [deg]
 DEC          : Declination [deg]
 Z            : Redshift
 K            : Convergence at the location of galaxy
 G1,G2        : Shear at the location of galaxy
 N1,N2        : Noise at the location of galaxy
 K_IA         : Intrinsic alignment converegence
 G1_IA, G2_IA : Intrinsic alignment shear
 ```
 In general what is observed is ```G1+N1+G1_IA``` and ```G2+N2+G2_IA```. 